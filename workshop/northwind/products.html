<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
</head>

<body>
    <nav>
        <a href="./index.html">Home</a> |
        <a href="./products.html">Products</a>
    </nav>
    <h1>Products</h1>
    <form action="">
        <fieldset>
            <legend>Search</legend>
            <label for="search-type-dropdown-list">By</label>
            <select name="search-type-dropdown-list" id="search-type-dropdown-list">
                <option value="">Select One...</option>
                <option value="category">Search by Category</option>
                <option value="all">View All</option>
            </select>

            <label for="category-dropdown-list">Categories</label>
            <select name="category-dropdown-list" id="category-dropdown-list">
                <option value="">Select</option>
            </select>
        </fieldset>
    </form>

    <table id="products-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Price</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</body>
<script>
    window.onload = () => {
        const searchTypeDropdownList = document.querySelector("#search-type-dropdown-list");
        const categoryDropdownList = document.querySelector("#category-dropdown-list");
        const productsTbody = document.querySelector("#products-table tbody");

        function hide(element) {
            element.style.display = "none";
            const labelForElement = document.querySelector(`label[for=${element.id}]`);
            if (labelForElement) { labelForElement.style.display = "none"; }
        }

        function show(element) {
            element.style.display = "block";
            const labelForElement = document.querySelector(`label[for=${element.id}]`);
            if (labelForElement) { labelForElement.style.display = "block"; }
        }

        function loadCategories() {
            return fetch("http://localhost:8081/api/categories").then((response) => response.json())
        }

        function fillCategoriesDropdownList(categories) {
            for (const category of categories) {
                const option = document.createElement("option");
                option.value = category.categoryId;
                option.text = category.name;
                categoryDropdownList.appendChild(option);
            }
        }

        function loadProducts() {
            return fetch("http://localhost:8081/api/products").then((response) => response.json())
        }

        function filterProductsByCategory(products) {
            const selectedCategoryId = Number(categoryDropdownList.value)
            if (!selectedCategoryId) return products;
            return products.filter(product => product.categoryId === selectedCategoryId)
        }

        function createViewDetailsLink(product) {
            const viewDetailsLink = document.createElement('a');
            viewDetailsLink.href = `./product-details.html?id=${product.productId}`
            viewDetailsLink.innerText = "View Details"
            return viewDetailsLink;
        }

        function clearTableBody() {
            productsTbody.innerHTML = " ";
        }

        function fillProductsTable(products) {
            clearTableBody();
            for (const product of products) {
                let row = productsTbody.insertRow(-1);
                let cell1 = row.insertCell(0);
                let cell2 = row.insertCell(1);
                let cell3 = row.insertCell(2);
                cell1.innerText = product.productName;
                cell2.innerText = Number(product.unitPrice).toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD',
                });

                const viewDetailsLink = createViewDetailsLink(product);
                cell3.appendChild(viewDetailsLink);
            }
        }

        function loadCategoriesIntoDropdownList(params) {
            loadCategories().then((categories) => fillCategoriesDropdownList(categories));
        }

        function loadProductsIntoTable() {
            loadProducts().then((products) => fillProductsTable(products));
        }

        function loadFilteredProductsIntoTable() {
            loadProducts().then((products) => filterProductsByCategory(products)).then((products) => fillProductsTable(products));
        }

        function searchTypeDropdownListChanged() {
            switch (searchTypeDropdownList.value) {
                case "category":
                    if (categoryDropdownList.options.length === 1) {
                        loadCategoriesIntoDropdownList();
                    }
                    show(categoryDropdownList);
                    break;
                case "all":
                    categoryDropdownList.value = "";
                    hide(categoryDropdownList);
                    loadProductsIntoTable();
                    break;
                default:
                    categoryDropdownList.value = "";
                    hide(categoryDropdownList);
                    clearTableBody(productsTbody);
                    break;
            }
        }

        hide(categoryDropdownList);
        categoryDropdownList.onchange = loadFilteredProductsIntoTable;
        searchTypeDropdownList.onchange = searchTypeDropdownListChanged;
    }
</script>

</html>